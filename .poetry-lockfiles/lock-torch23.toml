#:schema https://json.schemastore.org/pyproject.json
# Do *not* edit pyproject.toml directly; it gets generated by tox -m lock. This is a hack to let us
# specify different versions of torch in various tox environments. Any changes should be added to
# .poetry-lockfiles/pyproject.in, and then you should re-run tox -m lock.

[tool.poetry]
name = "graphpatch"
version = "0.2.0"
description = "graphpatch is a library for activation patching on PyTorch neural network models."
authors = ["Evan Lloyd <evan.t.lloyd@gmail.com>"]
classifiers = ["Development Status :: 4 - Beta"]
documentation = "https://graphpatch.readthedocs.io/en/latest/index.html"
homepage = "https://www.graphpatch.dev"
license = "MIT"
packages = [{ include = "graphpatch" }]
readme = "README.md"
keywords = [
    "mechanistic interpretability",
    "interpretability",
    "pytorch",
    "torch",
    "activation patch",
    "ablation",
    "transformer",
    "large language model",
    "llm",
]
repository = "https://github.com/evan-lloyd/graphpatch"


[tool.poetry.dependencies]
# Due to beta-ness of torch.compile(), minor releases demonstrably break our code, so for now cap
# to tested versions but optimistically allow patch releases (which so far have been non-breaking).
torch = ">=2, <2.4"
# torch does not list numpy as a mandatory requirement, but it is in fact required for certain
# codepaths encountered during compile()
numpy = ">=1.17"
# torch.compile(): 3.8-3.11
python = ">=3.8.1, <3.12"
accelerate = { version = ">=0.15.0", optional = true }
# slightly bumped from transformers setup.py (we don't depend on it directly), which had >=0.1.91
# (0.1.92 was yanked and there was never a 0.1.93); I couldn't get 0.1.91 to build so couldn't
# verify it worked. It's optional, technically, but needed for Llama.
sentencepiece = { version = ">=0.1.94", optional = true }
# Somewhat arbitrary, but this is the first version with Llama, which we use in tests
transformers = { version = ">=4.28.0", optional = true }
bitsandbytes = { version = ">=0.35.4", optional = true, markers = "sys_platform != 'darwin'" }
transformer-lens = { version = ">=1.16.0", optional = true }

[tool.poetry.extras]
transformers = [
    "transformers",
    "sentencepiece",
    "protobuf",
    "accelerate",
    "bitsandbytes",
    "scipy",
    "setuptools",
]
transformer-lens = ["transformer-lens"]

[tool.poetry.group.dev.dependencies]
ipykernel = "^6.25.2"
tuna = "^0.5.11"
jupyterlab = "^4.0.7"
ipywidgets = "^8.1.1"
tox = "^4.11.3"
sphobjinv = "^2.3.1"

[tool.poetry.group.testenv-lint.dependencies]
flake8 = "^6.1.0"

[tool.poetry.group.testenv-format.dependencies]
black = { extras = ["jupyter"], version = "^23.10.1" }
isort = "^5.12.0"

[tool.poetry.group.testenv-typecheck.dependencies]
mypy = "^1.6.1"

[tool.poetry.group.testenv-test.dependencies]
pytest = "^7.4.2"
pytest-mock = "^3.12.0"
snapshottest = "^0.6.0"
ipython = "^8.12.3"
pdbpp = "^0.10.3"
pytest-xdist = "^3.5.0"
pytest-env = "^1.1.3"

[tool.poetry.group.testenv-debug]
optional = true

[tool.poetry.group.testenv-debug.dependencies]
# Useful for debugging pickling errors; see https://pygobject.gnome.org/getting_started.html
# to set up interactive viewing of objgraph for your OS (needs GTK 3 bindings).
# eg, MacOS: brew install pygobject3 gtk+3 graphviz
xdot = "^1.3"
graphviz = "^0.20.3"
objgraph = "^3.6.1"

[tool.poetry.group.testenv-test-notebooks.dependencies]
nbmake = "^1.4.6"

[tool.poetry.group.testenv-test-coverage.dependencies]
pytest-cov = "^4.1.0"

[tool.poetry.group.testenv-docs.dependencies]
python = ">=3.10, <3.11"
sphinx = { version = "^7.2.6", markers = "python_version >= '3.9'" }
furo = "^2023.9.10"
sphinx-autobuild = "^2021.3.14"
docutils = { version = "^0.21.2", markers = "python_version >= '3.9'" }
sphinx-markdown-builder = "^0.6.6"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
[tool.poetry.group.torch.dependencies]
torch = [
    { platform = "darwin", url = "https://download.pytorch.org/whl/cpu/torch-2.3.0-cp311-none-macosx_11_0_arm64.whl", python = ">=3.11,<3.12" },
    { platform = "darwin", url = "https://download.pytorch.org/whl/cpu/torch-2.3.0-cp310-none-macosx_11_0_arm64.whl", python = ">=3.10,<3.11"},
    { platform = "darwin", url = "https://download.pytorch.org/whl/cpu/torch-2.3.0-cp39-none-macosx_11_0_arm64.whl", python = ">=3.9,<3.10"},
    { platform = "darwin", url = "https://download.pytorch.org/whl/cpu/torch-2.3.0-cp38-none-macosx_11_0_arm64.whl", python = ">=3.8,<3.9"},
    { platform = "linux", url = "https://download.pytorch.org/whl/cu118/torch-2.3.0%2Bcu118-cp311-cp311-linux_x86_64.whl", python = ">=3.11,<3.12"},
    { platform = "linux", url = "https://download.pytorch.org/whl/cu118/torch-2.3.0%2Bcu118-cp310-cp310-linux_x86_64.whl", python = ">=3.10,<3.11"},
    { platform = "linux", url = "https://download.pytorch.org/whl/cu118/torch-2.3.0%2Bcu118-cp39-cp39-linux_x86_64.whl", python = ">=3.9,<3.10"},
    { platform = "linux", url = "https://download.pytorch.org/whl/cu118/torch-2.3.0%2Bcu118-cp38-cp38-linux_x86_64.whl", python = ">=3.8,<3.9"},
]
